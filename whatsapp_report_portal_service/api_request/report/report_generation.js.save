const db = require("../../db_connect/dynamic_connect");
require("dotenv").config();
const main = require('../../logger')

async function report_update(req) {
    var logger_all = main.logger_all
    var logger = main.logger

    try {
        var database = req.body.database;
        var table_name = req.body.table_name;
        var compose_whatsapp_id = req.body.compose_whatsapp_id;
	var user_id = req.body.compose_user;
        var report_group = req.body.report_group;

        var status = ["BLOCKED", "DELIVERED", "INCAPABLE", "INVALID", "READ", "SENT", "NOT AVAILABLE", "FAILED"]
        var status_failure = ["BLOCKED", "INCAPABLE", "INVALID", "NOT AVAILABLE", "FAILED"]
        var status_success = ["DELIVERED", "READ", "SENT"]

        var select_count = `SELECT COUNT(*) as count FROM ${database}.${table_name} WHERE compose_whatsapp_id = '${compose_whatsapp_id}'`
        logger_all.info("[Select query request] : " + select_count);
        var select_count_result = await db.query(select_count);
        logger_all.info("[Select query response] : " + JSON.stringify(select_count_result))
        // var limit_count = 500;
        var total_count_data = select_count_result[0].count;

	var select_date = `SELECT * FROM ${database}.compose_whatsapp_tmpl_${user_id} WHERE compose_whatsapp_id = '${compose_whatsapp_id}'`
        logger_all.info("[Select query request] : " + select_date);
        var select_date_result = await db.query(select_date);
        logger_all.info("[Select query response] : " + JSON.stringify(select_date_result))
        // var limit_count = 500;
        var com_date = select_date_result[0].whatsapp_entry_date;
      
        // Get current time in IST
        const ISTTime = new Date(com_date);
	givenDateTime.setMinutes(I.getMinutes() + 30);
        const currentTime = new Date(ISTTime.getTime() + (5.5 * 60 * 60 * 1000));

        for (var i = 0; i < total_count_data; i) {

            console.log("Current time in IST:", currentTime);

            // Generate a random time between current time and one hour ahead time in IST
            const randomTime = new Date(currentTime.getTime() + Math.floor(Math.random() * 3600000));

            // Format the random time as "yyyy-mm-dd hh:ii:ss"
            const formattedRandomTime = randomTime.toISOString().slice(0, 19).replace('T', ' ');
            // Get random value from array
            const randomcount = Math.floor(Math.random() * (701 - 500)) + 500;

            var query = `update ${database}.${table_name} SET delivery_date = '${formattedRandomTime}' WHERE compose_whatsapp_id = '${compose_whatsapp_id}' AND report_group = '${report_group}' AND delivery_date is NULL ORDER BY RAND()
            LIMIT ${randomcount}`
            logger_all.info("[Select query request] : " + query);
            var report_update = await db.query(query);
            logger_all.info("[Select query response] : " + JSON.stringify(report_update))

            i = i + randomcount
        }

/*        const tenPercentValue = Math.ceil((10 / 100) * total_count_data);

        // Calculate 85% value
        const eightyFivePercentValue = Math.ceil((85 / 100) * total_count_data);
        const FivePercentValue = Math.ceil((5 / 100) * total_count_data);

        for (var k = 0; k < tenPercentValue; k) {

            const randomIndex = Math.floor(Math.random() * status_failure.length);

            // Get random value from array
            const randomValue = status_failure[randomIndex];
            const randomcount = Math.floor(Math.random() * (701 - 500)) + 500;

            console.log("Random value:", randomValue);
            var query = `update ${database}.${table_name} SET delivery_status = '${randomValue}' WHERE compose_whatsapp_id = '${compose_whatsapp_id}' AND report_group = '${report_group}' AND delivery_status is NULL ORDER BY RAND()
            LIMIT ${randomcount}`
            logger_all.info("[Select query request] : " + query);
            var report_update = await db.query(query);
            logger_all.info("[Select query response] : " + JSON.stringify(report_update))
            k = k + randomcount;
        }

        for (var k = 0; k < eightyFivePercentValue; k) {

            const randomIndex = Math.floor(Math.random() * status_success.length);

            // Get random value from array
            const randomValue = status_success[randomIndex];
            const randomcount = Math.floor(Math.random() * (701 - 500)) + 500;

            console.log("Random value:", randomValue);
            var query = `update ${database}.${table_name} SET delivery_status = '${randomValue}' WHERE compose_whatsapp_id = '${compose_whatsapp_id}' AND report_group = '${report_group}' AND delivery_status is NULL ORDER BY RAND()
            LIMIT ${randomcount}`
            logger_all.info("[Select query request] : " + query);
            var report_update = await db.query(query);
            logger_all.info("[Select query response] : " + JSON.stringify(report_update))
            k = k + randomcount;
        }

        for (var k = 0; k < FivePercentValue; k) {

            const randomIndex = Math.floor(Math.random() * status.length);

            // Get random value from array
            const randomValue = status[randomIndex];
            const randomcount = Math.floor(Math.random() * (501 - 100)) + 100;

            console.log("Random value:", randomValue);
            var query = `update ${database}.${table_name} SET delivery_status = '${randomValue}' WHERE compose_whatsapp_id = '${compose_whatsapp_id}' AND report_group = '${report_group}' AND delivery_status is NULL ORDER BY RAND()
            LIMIT ${randomcount}`
            logger_all.info("[Select query request] : " + query);
            var report_update = await db.query(query);
            logger_all.info("[Select query response] : " + JSON.stringify(report_update))
            k = k + randomcount;
        }*/


	for (var k = 0; k < total_count_data; k) {

            const randomIndex = Math.floor(Math.random() * status_success.length);

            // Get random value from array
            const randomValue = status_success[randomIndex];
            const randomcount = Math.floor(Math.random() * (701 - 500)) + 500;

            console.log("Random value:", randomValue);
 var query = `update ${database}.${table_name} SET delivery_status = '${randomValue}' WHERE compose_whatsapp_id = '${compose_whatsapp_id}' AND report_group = '${report_group}' AND delivery_status is NULL ORDER BY RAND()
            LIMIT ${randomcount}`

            logger_all.info("[Select query request] : " + query);
            var report_update = await db.query(query);
            logger_all.info("[Select query response] : " + JSON.stringify(report_update))
            k = k + randomcount;
        }

        return { response_code: 1, response_status: 200, response_msg: 'Success' };
        // }

    }

    catch (err) {
        // Failed - call_index_signin Sign in function
        logger_all.info("[country list report] Failed - " + err);
        return { response_code: 0, response_status: 201, response_msg: 'Error Occurred.' };
    }
}

module.exports = {
    report_update
};
